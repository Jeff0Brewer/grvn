const plusIcon = '<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 20 20" aria-hidden="true" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"></path></svg>'
const smoothIcon = '<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 256 256" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M242.86,133.1c-23,49-43,70.9-64.82,70.9-27.64,0-43.8-34.44-60.9-70.9C110,117.78,102.53,102,94.92,90.73,88.39,81.09,82.53,76,78,76c-3.82,0-18.24,4.12-43.09,57.1a12,12,0,0,1-21.73-10.2c23-49,43-70.9,64.82-70.9,27.64,0,43.8,34.44,60.9,70.9,7.19,15.32,14.61,31.15,22.22,42.37,6.53,9.64,12.39,14.73,17,14.73,3.82,0,18.24-4.12,43.09-57.1a12,12,0,0,1,21.73,10.2Z"></path></svg>'
const linearIcon = '<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 256 256" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M238.29,138.22l-104,64A12,12,0,0,1,116,192V85.47L30.29,138.22a12,12,0,0,1-12.58-20.44l104-64A12,12,0,0,1,140,64V170.53l85.71-52.75a12,12,0,1,1,12.58,20.44Z"></path></svg>'
const drawPathIcon = '<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M944 224c-44.192 0-79.999 35.824-79.999 80 0 9.072 1.84 17.632 4.607 25.76L673.6 497.68C659.92 486.784 642.848 480 624 480c-21.743 0-41.407 8.736-55.808 22.816l-152.752-76.48C412.465 384.848 378.241 352 336 352c-44.175 0-80 35.824-80 80 0 12.096 2.88 23.44 7.68 33.712L107.936 645.296C99.2 642.032 89.872 640 80 640c-44.176 0-80 35.824-80 80s35.824 80 80 80 80-35.824 80-80c0-10.64-2.176-20.767-5.952-30.048l158.272-181.92C319.856 510.368 327.696 512 336 512c23.28 0 44.047-10.112 58.671-26l149.408 74.912C544.608 604.656 580.127 640 624 640c44.193 0 80-35.824 80-80 0-1.424-.336-2.752-.416-4.16L911.68 377.072C921.584 381.456 932.463 384 944 384c44.193 0 80-35.808 80-80 0-44.176-35.807-80-79.999-80z"></path></svg>'
const skipBackIcon = '<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M175 100v137.8L403.9 98.1c5.3-3.1 12.1.7 12.1 6.9v302c0 6.2-6.7 10-12.1 6.9L175 274.2V412c0 2.2-1.8 4-4 4h-71c-2.2 0-4-1.8-4-4V100c0-2.2 1.8-4 4-4h71c2.2 0 4 1.8 4 4z"></path></svg>'
const rewindIcon = '<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M249.6 402V110L32 256l217.6 146zm12.8-146L480 402V110L262.4 256z"></path></svg>'
const stopIcon = '<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M80 80h352v352H80z"></path></svg>'
const playIcon = '<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M96 52v408l320-204L96 52z"></path></svg>'
const pauseIcon = '<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M96 448h106.7V64H96v384zM309.3 64v384H416V64H309.3z"></path></svg>'
const fastforwardIcon = '<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M480 256L262.4 110v292L480 256zM32 110v292l217.6-146L32 110z"></path></svg>'
const skipForwardIcon = '<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M337 100v137.8L108.1 98.1C102.7 95 96 98.8 96 105v302c0 6.2 6.7 10 12.1 6.9L337 274.2V412c0 2.2 1.8 4 4 4h71c2.2 0 4-1.8 4-4V100c0-2.2-1.8-4-4-4h-71c-2.2 0-4 1.8-4 4z"></path></svg>'
const downloadIcon = '<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 384 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M224 136V0H24C10.7 0 0 10.7 0 24v464c0 13.3 10.7 24 24 24h336c13.3 0 24-10.7 24-24V160H248c-13.2 0-24-10.8-24-24zm76.45 211.36l-96.42 95.7c-6.65 6.61-17.39 6.61-24.04 0l-96.42-95.7C73.42 337.29 80.54 320 94.82 320H160v-80c0-8.84 7.16-16 16-16h32c8.84 0 16 7.16 16 16v80h65.18c14.28 0 21.4 17.29 11.27 27.36zM377 105L279.1 7c-4.5-4.5-10.6-7-17-7H256v128h128v-6.1c0-6.3-2.5-12.4-7-16.9z"></path></svg>'
const uploadIcon = '<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 384 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M224 136V0H24C10.7 0 0 10.7 0 24v464c0 13.3 10.7 24 24 24h336c13.3 0 24-10.7 24-24V160H248c-13.2 0-24-10.8-24-24zm65.18 216.01H224v80c0 8.84-7.16 16-16 16h-32c-8.84 0-16-7.16-16-16v-80H94.82c-14.28 0-21.41-17.29-11.27-27.36l96.42-95.7c6.65-6.61 17.39-6.61 24.04 0l96.42 95.7c10.15 10.07 3.03 27.36-11.25 27.36zM377 105L279.1 7c-4.5-4.5-10.6-7-17-7H256v128h128v-6.1c0-6.3-2.5-12.4-7-16.9z"></path></svg>'
const cameraIcon = '<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 20 20" aria-hidden="true" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M3.25 4A2.25 2.25 0 001 6.25v7.5A2.25 2.25 0 003.25 16h7.5A2.25 2.25 0 0013 13.75v-7.5A2.25 2.25 0 0010.75 4h-7.5zM19 4.75a.75.75 0 00-1.28-.53l-3 3a.75.75 0 00-.22.53v4.5c0 .199.079.39.22.53l3 3a.75.75 0 001.28-.53V4.75z"></path></svg>'
const eyeIcon = '<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" aria-hidden="true" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M12 15a3 3 0 100-6 3 3 0 000 6z"></path><path fill-rule="evenodd" d="M1.323 11.447C2.811 6.976 7.028 3.75 12.001 3.75c4.97 0 9.185 3.223 10.675 7.69.12.362.12.752 0 1.113-1.487 4.471-5.705 7.697-10.677 7.697-4.97 0-9.186-3.223-10.675-7.69a1.762 1.762 0 010-1.113zM17.25 12a5.25 5.25 0 11-10.5 0 5.25 5.25 0 0110.5 0z" clip-rule="evenodd"></path></svg>'
const closeIcon = '<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 20 20" aria-hidden="true" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"></path></svg>'

const LOW_COLOR = '#999'
const INPUT_PRECISION = 2
const DEFAULT_DURATION = 1000

const menu = {
    visible: false,
    steps: [],
    durations: [],
    smooth: true,
    currStep: null,
    drawPath: true,
    cameraPath: null,
    tracePath: null,
    traceChanged: true,
    axisPosition: null,
    axisChanged: true,
    getCameraPosition: () => [0, 0, 0],
    getCameraFocus: () => [0, 0, 0]
}

// update rendered path, must call whenever steps / smooth changes
// to maintain coordination with menu state
const updateTracePath = () => {
    if (menu.steps.length > 0 && menu.drawPath) {
        // don't need durations for trace use duration
        // of 1 for easy iteration through full path
        menu.tracePath = new CameraPath(menu.steps, [1], menu.smooth)
    } else {
        menu.tracePath = null
    }
    menu.traceChanged = true
}

// update path being followed, when set
// path will be followed until menu.cameraPath is set to null
const updateCameraPath = () => {
    if (menu.steps.length > 0) {
        menu.cameraPath = new CameraPath(menu.steps, menu.durations, menu.smooth)
        updatePlayPauseDom()
    } else {
        menu.cameraPath = null
    }
    menu.currStep = null
    updateCurrStepDom()
}

const appendStep = () => {
    if (menu.steps.length > 0) {
        menu.durations.push(DEFAULT_DURATION)
    }
    menu.steps.push({
        position: menu.getCameraPosition(),
        focus: null
    })
    updateTracePath()
    renderSteps()
}

const deleteStep = (i) => {
    if (i + 1 < menu.steps.length) {
        menu.durations.splice(i, 1)
    } else if (i - 1 > 0) {
        menu.durations.splice(i - 1, 1)
    }
    menu.steps.splice(i, 1)
    menu.axisPosition = null
    menu.axisChanged = true
    updateTracePath()
    renderSteps()
}

// play pause state changed in many places
// use this helper to update dom when changed
const updatePlayPauseDom = () => {
    const el = document.getElementById('playPause')
    el.innerHTML = (menu.cameraPath === null || menu.cameraPath.paused)
        ? playIcon
        : pauseIcon
}

// smooth state can be changed on file upload or menu interact
// use helper to update dom when changed
const updateSmoothDom = () => {
    const el = document.getElementById('smooth')
    el.innerHTML = menu.smooth ? smoothIcon : linearIcon
}

// curr step changed in many places
// use helper after setting value
const updateCurrStepDom = () => {
    const el = document.getElementById('currStep')
    el.style.display = menu.currStep === null ? 'none' : 'flex'
    el.innerHTML = `step: ${menu.currStep}`
}

const toggleSmooth = () => {
    menu.smooth = !menu.smooth
    updateSmoothDom()
    updateTracePath()
}

const toggleDrawPath = () => {
    menu.drawPath = !menu.drawPath
    const el = document.getElementById('drawPath')
    el.style.color = menu.drawPath ? '#fff' : LOW_COLOR
    if (!menu.drawPath) {
        menu.axisPosition = null
        menu.axisChanged = true
    }
    updateTracePath()
}

const stopPath = () => {
    menu.cameraPath = null
    menu.currStep = null
    updateCurrStepDom()
    updatePlayPauseDom()
}

const togglePlayPause = () => {
    if (menu.cameraPath !== null) {
        menu.cameraPath.paused = !menu.cameraPath.paused
        menu.currStep = null
        updateCurrStepDom()
    } else {
        updateCameraPath()
    }
    updatePlayPauseDom()
}

const prevStep = () => {
    if (menu.cameraPath !== null) {
        const stepInd = menu.cameraPath.prevStep()
        if (menu.cameraPath.paused) {
            menu.currStep = stepInd
            updateCurrStepDom()
        }
    }
}

const nextStep = () => {
    if (menu.cameraPath !== null) {
        const stepInd = menu.cameraPath.nextStep()
        if (menu.cameraPath.paused) {
            menu.currStep = stepInd
            updateCurrStepDom()
        }
    }
}

const firstStep = () => {
    if (menu.cameraPath !== null) {
        const stepInd = menu.cameraPath.firstStep()
        if (menu.cameraPath.paused) {
            menu.currStep = stepInd
            updateCurrStepDom()
        }
    }
}

const lastStep = () => {
    if (menu.cameraPath !== null) {
        const stepInd = menu.cameraPath.lastStep()
        if (menu.cameraPath.paused) {
            menu.currStep = stepInd
            updateCurrStepDom()
        }
    }
}

const downloadPath = () => {
    const csv = serializePath(menu.steps, menu.durations, menu.smooth)
    const el = document.createElement('a')
    el.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(csv))
    el.setAttribute('download', 'GRVN_camera_path.csv')
    el.style.display = 'none'

    document.body.appendChild(el)
    el.click()
    document.body.removeChild(el)
}

const uploadPath = () => {
    const fileInput = document.getElementById('uploadPath')
    if (!fileInput.files?.length) {
        throw new Error('No file uploaded')
    }
    const file = fileInput.files[0]
    const reader = new FileReader()
    reader.onload = (e) => {
        const csv = e.target.result
        const { steps, durations, smooth } = deserializePath(csv)
        menu.steps = steps
        menu.durations = durations
        menu.smooth = smooth
        renderSteps()
        updateSmoothDom()
        updateTracePath()
    }
    reader.readAsText(file)
    fileInput.value = ''
}

const roundToPrecision = (val, decimals) => {
    const mul = Math.pow(10, decimals)
    return Math.round(val * mul) / mul
}

const renderSteps = () => {
    const steps = document.getElementById('steps')
    steps.innerHTML = ''
    steps.onmouseleave = () => {
        menu.axisPosition = null
        menu.axisChanged = true
    }
    for (let i = 0; i < menu.steps.length; i++) {
        const wrap = document.createElement('div')
        wrap.classList.add('stepWrap')

        const step = getStepDom(i)
        wrap.appendChild(step)

        if (i < menu.steps.length - 1) {
            const duration = getDurationDom(i)
            wrap.appendChild(duration)
        }

        steps.appendChild(wrap)
    }
}

const getStepDom = (i) => {
    const step = menu.steps[i]

    const wrap = document.createElement('div')
    wrap.classList.add('step')
    wrap.onmouseenter = () => {
        if (menu.drawPath) {
            menu.axisPosition = step.position
        } else {
            menu.axisPosition = null
        }
        menu.axisChanged = true
        if (menu.drawPath) {
            wrap.classList.add('stepHighlight')
        }
    }
    wrap.onmouseleave = () => {
        wrap.classList.remove('stepHighlight')
    }

    const posRow = document.createElement('div')
    posRow.classList.add('stepRow')
    wrap.appendChild(posRow)

    const updatePos = () => {
        step.position = menu.getCameraPosition()
        updateTracePath()
        renderSteps()
    }
    const clearPos = () => {
        deleteStep(i)
    }
    const posInput = getPointInput(step.position, updatePos, clearPos, cameraIcon)

    posRow.appendChild(posInput)

    if (step.focus === null) {
        const addFocus = document.createElement('button')
        addFocus.onclick = () => {
            step.focus = menu.getCameraFocus()
            updateTracePath()
            renderSteps()
        }
        addFocus.innerHTML = eyeIcon
        posRow.appendChild(addFocus)
    } else {
        const focusRow = document.createElement('div')
        focusRow.classList.add('stepRow')

        const updateFocus = () => {
            step.focus = menu.getCameraFocus()
            updateTracePath()
            renderSteps()
        }
        const clearFocus = () => {
            step.focus = null
            updateTracePath()
            renderSteps()
        }
        const focusInput = getPointInput(step.focus, updateFocus, clearFocus, eyeIcon)
        focusRow.appendChild(focusInput)
        wrap.appendChild(focusRow)
    }

    return wrap
}

const getDurationDom = (i) => {
    const wrap = document.createElement('div')
    wrap.classList.add('duration')

    const input = getTextInput()
    input.value = roundToPrecision(menu.durations[i] / 1000, INPUT_PRECISION)
    input.oninput = (e) => {
        const value = parseFloat(e.target.value)
        if (!Number.isNaN(value)) {
            menu.durations[i] = value * 1000
        }
    }

    const label = document.createElement('p')
    label.innerHTML = 'sec'

    wrap.appendChild(input)
    wrap.appendChild(label)

    return wrap
}

const getPointInput = (point, update, clear, icon) => {
    const getIndSetter = (ind) => {
        return (e) => {
            const value = parseFloat(e.target.value)
            if (!Number.isNaN(value)) {
                point[ind] = value
                updateTracePath()
            }
        }
    }

    const wrap = document.createElement('div')
    wrap.classList.add('pointInput')

    const updateButton = document.createElement('button')
    updateButton.onclick = update
    updateButton.innerHTML = icon

    const xInput = getTextInput()
    xInput.value = roundToPrecision(point[0], INPUT_PRECISION)
    xInput.oninput = getIndSetter(0)
    xInput.classList.add('xInput')
    const yInput = getTextInput()
    yInput.value = roundToPrecision(point[1], INPUT_PRECISION)
    yInput.oninput = getIndSetter(1)
    yInput.classList.add('yInput')
    const zInput = getTextInput()
    zInput.value = roundToPrecision(point[2], INPUT_PRECISION)
    zInput.oninput = getIndSetter(2)
    zInput.classList.add('zInput')

    const clearButton = document.createElement('button')
    clearButton.onclick = clear
    clearButton.innerHTML = closeIcon

    wrap.appendChild(updateButton)
    wrap.appendChild(xInput)
    wrap.appendChild(yInput)
    wrap.appendChild(zInput)
    wrap.appendChild(clearButton)

    return wrap
}

const getTextInput = () => {
    const input = document.createElement('input')
    input.setAttribute('type', 'text')
    return input
}

const cameraMenuRoot = document.getElementById('cameraMenuRoot')
const initCamMenu = () => {
    cameraMenuRoot.innerHTML = `
        <div id="cameraMenu" class="menu" style="display:none;">
            <div id="steps" class="steps"></div>
            <div class="middleRow">
                <button class="addStep" onclick="appendStep()">
                    ${plusIcon}
                </button>
                <button class="startButton" onclick="updateCameraPath()">
                    update path
                </button>
            </div>
            <div class="bottomRow">
                <div class="pathControls">
                    <button id="smooth" onclick="toggleSmooth()">
                        ${menu.smooth ? smoothIcon : linearIcon}
                    </button>
                    <button 
                        id="drawPath" 
                        onclick="toggleDrawPath()"
                        style=${`color:${menu.drawPath ? '#fff' : LOW_COLOR}`}
                    >
                        ${drawPathIcon}
                    </button>
                </div>
                <div class="playControls">
                    <button class="skipIcon" onclick="firstStep()">
                        ${skipBackIcon}
                    </button>
                    <button onclick="prevStep()">
                        ${rewindIcon}
                    </button>
                    <button onclick="stopPath()">
                        ${stopIcon}
                    </button>
                    <button id="playPause" onclick="togglePlayPause()">
                        ${playIcon}
                    </button>
                    <button onclick="nextStep()">
                        ${fastforwardIcon}
                    </button>
                    <button class="skipIcon" onclick="lastStep()">
                        ${skipForwardIcon}
                    </button>
                </div>
                <div class="fileControls">
                    <button onclick="downloadPath()">
                        ${downloadIcon}
                    </button>
                    <label>
                        <input 
                            id="uploadPath"
                            type="file" 
                            style="display:none;" 
                            onchange="uploadPath()" 
                        />
                        ${uploadIcon}
                    </label>
                </div>
                <p class="stepCount" id="currStep" style="display:none;"></p>
            </div>
        </div>
    `

    window.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 'm') {
            menu.visible = !menu.visible
            const el = document.getElementById('cameraMenu')
            el.style.display = menu.visible ? 'block' : 'none'
        }
    })
}

initCamMenu()
